# ‚ú® Active les √©v√©nements de gestion de connexions
events {}

# üåê Configuration principale du serveur HTTP
http {
  # üì¶ Charge les types MIME standards (pour que Nginx comprenne .js, .css, etc.)
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # ‚öôÔ∏è Active l'envoi efficace de fichiers
  sendfile        on;

  # üîÅ Garde les connexions HTTP ouvertes 65s pour les optimiser
  keepalive_timeout  65;

  # üåê D√©clare les serveurs internes vers lesquels Nginx reverse proxy
  # (frontend non utilis√© car on sert les builds via "root")
  upstream backend {
    server server:8080;
  }

  # ---------------------------------------------
  # üåê 1. Compression GZIP pour tous les fichiers textes
  # ---------------------------------------------
  gzip on;  # ‚úÖ Active la compression
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    application/xml+rss
    image/svg+xml;  # ‚ö†Ô∏è Vite produit souvent des SVG
  gzip_min_length 256;  # Ne compresse que si > 256 octets
  gzip_vary on;         # Ajoute l'en-t√™te Vary pour le cache/CDN
  gzip_proxied any;     # Autorise compression m√™me derri√®re un proxy
  gzip_comp_level 6;    # Bon compromis entre perf & compression

  # ---------------------------------------------
  # üß† 2. Cache c√¥t√© client pour les fichiers statiques (HTML, JS, CSS, etc.)
  # ---------------------------------------------
  map $sent_http_content_type $expires {
    default                    off;
    text/html                  epoch;
    text/css                   max;
    application/javascript     max;
    application/json           max;
    image/svg+xml              max;
    font/woff2                 max;
  }

  # ============================================================
  # ‚úÖ MODE HTTP-ONLY TEMPORAIRE (√âTAPE 3)
  # Objectif : D√©marrer Nginx SANS certificats.
  # On garde le challenge Let's Encrypt, mais on NE redirige PAS vers HTTPS.
  # ============================================================

  # ---------------------------------------------
  # üåç 3. HTTP - FRONTEND (React build) + /api/
  # ---------------------------------------------
  server {
    listen 80;
    server_name powerwatt34.fr www.powerwatt34.fr;

    # üîê Autorise Let's Encrypt √† acc√©der au challenge (HTTP)
    location ^~ /.well-known/acme-challenge/ {
      root /usr/share/nginx/html;
      default_type "text/plain";
    }

    # üß† Active le cache (assets Vite hash√©s)
    location ^~ /assets/ {
      root /usr/share/nginx/html/powerwatt34;
      expires 1y;
      add_header Cache-Control "public, immutable";
      try_files $uri =404;
    }

    # üß† D√©sactive le cache sur index.html
    location = /index.html {
      root /usr/share/nginx/html/powerwatt34;
      add_header Cache-Control "no-store, no-cache, must-revalidate";
      expires off;
    }

    # üóÇÔ∏è Sert les fichiers du build React (SPA)
    location / {
      root /usr/share/nginx/html/powerwatt34;
      index index.html;
      try_files $uri $uri/ /index.html;
    }

    # üì° Proxy vers l'API backend (m√™me en HTTP)
    location /api/ {
      proxy_pass http://backend/;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }

  # ---------------------------------------------
  # üåç 3bis. HTTP - API (optionnel mais pratique)
  # ---------------------------------------------
  server {
    listen 80;
    server_name api.powerwatt34.fr;

    location ^~ /.well-known/acme-challenge/ {
      root /usr/share/nginx/html;
      default_type "text/plain";
    }

    location / {
      proxy_pass http://backend/;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }

  # ============================================================
  # ‚ùå √Ä D√âSACTIVER TEMPORAIREMENT (√âTAPE 3)
  # Raison : les certificats Let's Encrypt n'existent pas encore,
  # donc Nginx crash au d√©marrage.
  # On r√©activera tout √ßa √† l'√âTAPE 4 (Certbot).
  # ============================================================

  # ---------------------------------------------
  # üåç 3. Redirection HTTP ‚Üí HTTPS (√Ä D√âSACTIVER TEMPORAIREMENT)
  # ---------------------------------------------
  #
  # server {
  #   listen 80;
  #   server_name powerwatt34.fr www.powerwatt34.fr;
  #
  #   location ^~ /.well-known/acme-challenge/ {
  #     root /usr/share/nginx/html;
  #     default_type "text/plain";
  #   }
  #
  #   # üîÅ Redirige tout en HTTPS
  #   location / {
  #     return 301 https://$host$request_uri;
  #   }
  # }
  #
  # server {
  #   listen 80;
  #   server_name api.powerwatt34.fr;
  #
  #   location ^~ /.well-known/acme-challenge/ {
  #     root /usr/share/nginx/html;
  #     default_type "text/plain";
  #   }
  #
  #   location / {
  #     return 301 https://$host$request_uri;
  #   }
  # }

  # ---------------------------------------------
  # üåê 4. HTTPS - FRONTEND (√Ä D√âSACTIVER TEMPORAIREMENT)
  # ---------------------------------------------
  #
  # server {
  #   listen 443 ssl;
  #   http2 on;
  #   server_name powerwatt34.fr www.powerwatt34.fr;
  #
  #   ssl_certificate /etc/letsencrypt/live/powerwatt34.fr/fullchain.pem;
  #   ssl_certificate_key /etc/letsencrypt/live/powerwatt34.fr/privkey.pem;
  #
  #   ssl_protocols TLSv1.2 TLSv1.3;
  #   add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  #
  #   location ^~ /.well-known/acme-challenge/ {
  #     root /usr/share/nginx/html;
  #     default_type "text/plain";
  #   }
  #
  #   location ^~ /assets/ {
  #     root /usr/share/nginx/html/powerwatt34;
  #     expires 1y;
  #     add_header Cache-Control "public, immutable";
  #     try_files $uri =404;
  #   }
  #
  #   location = /index.html {
  #     root /usr/share/nginx/html/powerwatt34;
  #     add_header Cache-Control "no-store, no-cache, must-revalidate";
  #     expires off;
  #   }
  #
  #   location / {
  #     root /usr/share/nginx/html/powerwatt34;
  #     index index.html;
  #     try_files $uri $uri/ /index.html;
  #   }
  #
  #   location /api/ {
  #     proxy_pass http://backend/;
  #
  #     proxy_http_version 1.1;
  #     proxy_set_header Upgrade $http_upgrade;
  #     proxy_set_header Connection "upgrade";
  #
  #     proxy_set_header Host $host;
  #     proxy_set_header X-Real-IP $remote_addr;
  #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #     proxy_set_header X-Forwarded-Proto $scheme;
  #   }
  # }

  # ---------------------------------------------
  # üåê 5. HTTPS - BACKEND API (√Ä D√âSACTIVER TEMPORAIREMENT)
  # ---------------------------------------------
  #
  # server {
  #   listen 443 ssl;
  #   http2 on;
  #   server_name api.powerwatt34.fr;
  #
  #   ssl_certificate /etc/letsencrypt/live/api.powerwatt34.fr/fullchain.pem;
  #   ssl_certificate_key /etc/letsencrypt/live/api.powerwatt34.fr/privkey.pem;
  #
  #   ssl_protocols TLSv1.2 TLSv1.3;
  #   add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  #
  #   location ^~ /.well-known/acme-challenge/ {
  #     root /usr/share/nginx/html;
  #     default_type "text/plain";
  #   }
  #
  #   location / {
  #     proxy_pass http://backend/;
  #
  #     proxy_http_version 1.1;
  #     proxy_set_header Upgrade $http_upgrade;
  #     proxy_set_header Connection "upgrade";
  #
  #     proxy_set_header Host $host;
  #     proxy_set_header X-Real-IP $remote_addr;
  #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #     proxy_set_header X-Forwarded-Proto $scheme;
  #   }
  # }
}
